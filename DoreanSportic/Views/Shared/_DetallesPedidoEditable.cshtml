@model IEnumerable<DoreanSportic.Application.DTOs.PedidoDetalleDTO>
@using System.Globalization
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer

@{
    var culturaPersonalizada = (CultureInfo)CultureInfo.InvariantCulture.Clone();
    culturaPersonalizada.NumberFormat.NumberGroupSeparator = " ";
    culturaPersonalizada.NumberFormat.NumberDecimalSeparator = ".";
    // Saca pedidoId de ViewData o del primer item si lo traes
    var pedidoId = (int)(ViewData["PedidoId"] ?? 0);
}

<div id="detalles-root" data-pedido-id="@pedidoId" class="overflow-x-auto rounded-box border border-base-content/5 bg-base-100">
    <table class="table">
        <thead class="bg-primary text-white">
            <tr>
                <th>@Localizer["Producto"]</th>
                <th class="text-center">@Localizer["Cantidad"]</th>
                <th class="text-end">@Localizer["Precio unitario"]</th>
                <th class="text-end">@Localizer["Subtotal"]</th>
                <th class="text-end"></th>
            </tr>
        </thead>
        <tbody id="pedido-detalles-body">
            @foreach (var item in Model)
            {
                var producto = item.IdProductoNavigation;
                // precio estimado mostrado (tu subtotal / cantidad cuando carga por primera vez)
                var precioUnitEstimado = item.Cantidad > 0 ? (item.SubTotal / item.Cantidad) : 0m;

                <tr data-detalle-id="@item.Id">
                    <td>
                        <div class="font-semibold text-sm">@producto?.Nombre</div>
                    </td>
                    <td class="text-center" style="width:120px">
                        <input class="input input-bordered w-24 qty-input"
                               type="number" min="0" step="1" value="@item.Cantidad"
                               inputmode="numeric" />
                        <span class="qty-error text-red-600 text-xs"></span>
                    </td>
                    <td class="text-end cell-punit">₡@precioUnitEstimado.ToString("N2", culturaPersonalizada)</td>
                    <td class="text-end cell-subtotal">₡@item.SubTotal.ToString("N2", culturaPersonalizada)</td>

                    <td class="text-end">
                        <div class="flex flex-row justify-between">
                            <button id="btnModificar" class="btn btn-warning btn-xs text-black">@Localizer["Modificar"]</button>
                            <button id="btnEliminar" class="btn btn-xs text-white bg-[#FF4D4D]">@Localizer["Eliminar"]</button>
                        </div>
                    </td>

                </tr>
            }
            @{
                // totales iniciales (servidos por el server si los calculaste antes)
                var subIni = Model.Sum(x => x.SubTotal);
                var impIni = Math.Round(subIni * 0.13m, 2, MidpointRounding.AwayFromZero);
                var totIni = subIni + impIni;
            }

            <tr>
                <td colspan="5" class="text-end fw-bold">
                    <b>@Localizer["Subtotal"]:</b> <span id="totals-sub">₡@subIni.ToString("N2", culturaPersonalizada)</span>
                </td>
            </tr>
            <tr>
                <td colspan="5" class="text-end">
                    <b>@(Localizer["Impuesto (IVA 13%)"]): </b> <span id="totals-tax">₡@impIni.ToString("N2", culturaPersonalizada)</span>
                </td>
            </tr>
            <tr class="bg-primary text-white text-lg">
                <td colspan="5" class="text-end fw-bold">
                    <b>@(Localizer["Total a pagar"]): </b><span id="totals-grand">₡@totIni.ToString("N2", culturaPersonalizada)</span>
                </td>
            </tr>
            
        </tbody>
    </table>
</div>


<!-- Botón para completar compra -->
<div class="mt-4 flex p-2 gap-2">
    <span id="save-status" class="text-sm mr-2"></span>
    <button id="btn-completar-compra" class="btn btn-success text-white">
        <b>@Localizer["Pagar"]</b>
    </button>
</div>

