@model IEnumerable<DoreanSportic.Application.DTOs.PedidoDetalleDTO>
@using System.Globalization
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer

<!-- Para el separador de miles-->
@{
    var culturaPersonalizada = (CultureInfo)CultureInfo.InvariantCulture.Clone();
    culturaPersonalizada.NumberFormat.NumberGroupSeparator = " "; // separador de miles
    culturaPersonalizada.NumberFormat.NumberDecimalSeparator = "."; // separador decimal

    // Precio fijos de personalización

    const decimal PRECIO_FIJO_MENSAJE_PERSONALIZADO = 2000m;
    const decimal PRECIO_FIJO_FOTO = 3000m;

    // IVA
    const decimal IVA = 0.13m;

    decimal subtotalGeneral = 0m;


}

<h2 class="p-2 font-bold text-slate-700">
    @(Localizer["Detalle de productos"])
</h2>

<div class="overflow-x-auto rounded-box border border-base-content/5 bg-base-100">
    <table class="table">
        <thead class="bg-primary text-white">
            <tr>
                <th class="text-left">@Localizer["Producto"]</th>
                <th class="text-center">@Localizer["Cantidad"]</th>
                <th class="text-end">@Localizer["Precio"]</th>
                <th class="text-end">@Localizer["Subtotal"]</th>
                <th class="text-end">@Localizer["IVA (13%)"]</th>
                <th class="text-center">@Localizer["Total"]</th>
                <th class="text-end"></th>
            </tr>
        </thead>
        <tbody>
            @{
                decimal subTotalProducto = 0;
                DateTime hoy = DateTime.Today;

                foreach (var item in Model)
                {
                    var producto = item.IdProductoNavigation;
                    // precio estimado mostrado (tu subtotal / cantidad cuando carga por primera vez)
                    var precioUnitEstimado = item.Cantidad > 0 ? (item.SubTotal / item.Cantidad) : 0m;

                    // Cálculo por fila
                    var impFila = Math.Round(item.SubTotal * IVA, 2, MidpointRounding.AwayFromZero);
                    subTotalProducto += item.SubTotal; 
                    subtotalGeneral += item.SubTotal;
                    var totFila = item.SubTotal + impFila;


                    <tr data-detalle-id="@item.Id">
                        <td>
                            <div class="font-semibold text-sm">@producto?.Nombre</div>
                        </td>
                        <td class="text-center">@item.Cantidad</td>

                        <td class="text-end cell-punit">₡@precioUnitEstimado.ToString("N2", culturaPersonalizada)</td>
                        <td class="text-end cell-subtotal">₡@item.SubTotal.ToString("N2", culturaPersonalizada)</td>

                        <td class="text-end cell-tax">₡@impFila.ToString("N2", culturaPersonalizada)</td>
                        <td class="text-end cell-total">₡@totFila.ToString("N2", culturaPersonalizada)</td>

                    </tr>
                }
            }

        </tbody>
    </table>
</div>

<br />

<h2 class="p-2 font-bold text-slate-700">@(Localizer["Detalle de productos personalizados"])</h2>

<div class="overflow-x-auto rounded-box border border-base-content/5 bg-base-100">
    <table class="table">
        <thead class="bg-primary text-white">
            <tr>
                <th class="text-left">@(Localizer["Producto"])</th>
                <th class="text-center">@(Localizer["Mensaje"])</th>
                <th class="text-center">@(Localizer["Imagen personalizada"])</th>
                <th class="text-center">@(Localizer["Criterios de personalización"])</th>
            </tr>
        </thead>
        <tbody>
            @{

                decimal subTotalProductoGeneralizado = 0;
                var impuestoProductoPersonalizado = subTotalProductoGeneralizado * 0.13M;
            }

            @foreach (var item in Model)
            {
                if (item.IdEmpaque != null)
                {
                    var empaquePrecio = item.IdEmpaqueNavigation?.PrecioBase ?? 0m;

                    // Cálculo por fila
                    var impFila = Math.Round(item.SubTotal * IVA, 2, MidpointRounding.AwayFromZero);

                    <tr>
                        <td class="text-left">
                            @Html.DisplayFor(modelItem => item.IdProductoNavigation.Nombre)
                        </td>

                        @* Mostrar solo los primeros 15 caracteres del mensaje personalizado si sobrepasa 15 caracteres*@
                        <td class="text-left">
                            @(
                                                !string.IsNullOrEmpty(item.MensajePersonalizado)
                                                ? (item.MensajePersonalizado.Length > 15
                                                ? item.MensajePersonalizado.Substring(0, 15) + "..."
                                                : item.MensajePersonalizado)
                                                : ""
                                                )
                        </td>

                        <td class="text-center">
                            <img src="data:image/jpeg;base64,@Convert.ToBase64String(item.Foto!)"
                                 alt="Foto personalizada"
                                 style="width:100%;height:70px;object-fit:cover;border-radius:8px;" />

                        </td>

                        <td class="text-center">
                            <div class="flex flex-col gap-1">
                                <p style="font-size: 10px">
                                    <b>@Localizer["Empaque"]:</b>
                                    @item.IdEmpaqueNavigation?.TipoEmpaque
                                    <span class="ml-2">₡@empaquePrecio.ToString("N2", culturaPersonalizada)</span>
                                </p>
                                <p style="font-size: 10px">
                                    <b>@Localizer["Mensaje personalizado"]:</b>
                                    <span class="ml-2">₡@PRECIO_FIJO_MENSAJE_PERSONALIZADO.ToString("N2", culturaPersonalizada)</span>
                                </p>
                                <p style="font-size: 10px">
                                    <b>@Localizer["Foto"]:</b>
                                    <span class="ml-2">₡@PRECIO_FIJO_FOTO.ToString("N2", culturaPersonalizada)</span>
                                </p>
                            </div>
                        </td>
                    </tr>
                }
            }

        </tbody>
    </table>
</div>

@{
    var impuestoGeneral = Math.Round(subtotalGeneral * IVA, 2, MidpointRounding.AwayFromZero);
    var totalGeneral = subtotalGeneral + impuestoGeneral;

}

<table class="table mt-2">
    <tbody>
        <tr>
            <td colspan="5" class="text-end fw-bold">
                <b>@Localizer["Subtotal (productos + personalizaciones)"]:</b> ₡@subtotalGeneral.ToString("N2", culturaPersonalizada)
            </td>
        </tr>
        <tr>
            <td colspan="5" class="text-end">
                <b>@(Localizer["Impuesto (IVA 13%)"]): </b> ₡@impuestoGeneral.ToString("N2", culturaPersonalizada)
            </td>
        </tr>
        <tr class="bg-primary text-white text-lg">
            <td colspan="5" class="text-end fw-bold">
                <b>@(Localizer["Total pagado"]): ₡@totalGeneral.ToString("N2", culturaPersonalizada)</b>
            </td>
        </tr>

    </tbody>
</table>
